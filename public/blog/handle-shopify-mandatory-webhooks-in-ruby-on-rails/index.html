<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="author" content="Derek Morash">
<title>Handle Shopify Mandatory Webhooks in Ruby on Rails</title>


<meta name="description" content="A step-by-step guide on how to handle GDPR mandatory webhooks from Shopify.">



<meta property="og:site_name" content="" />
<meta property="og:locale" content="en_ca">
<meta property="og:title" content="Handle Shopify Mandatory Webhooks in Ruby on Rails" />
<meta property="og:type" content="video.movie" />

<meta property="og:description" content="A step-by-step guide on how to handle GDPR mandatory webhooks from Shopify." />

<meta property="og:url" content="https://derekmorash.com/blog/handle-shopify-mandatory-webhooks-in-ruby-on-rails/" />


  
<script>
  (function(){var docElement=document.documentElement;docElement.className=docElement.className.replace('no-js','js');function getCookieValue(cookie_name){cookie_name+="=";var cookie_value=false;var decoded_cookie=decodeURIComponent(document.cookie);var cookie_start=decoded_cookie.indexOf(cookie_name);var cookie_end=decoded_cookie.indexOf(";",cookie_start+1);cookie_end=cookie_end>1?cookie_end:decoded_cookie.length;if(cookie_start>=0&&cookie_end<=decoded_cookie.length){cookie_value=decoded_cookie.substring(cookie_start+cookie_name.length,cookie_end);}
if(cookie_value==="true"){cookie_value=true;}else if(cookie_value==="false"){cookie_value=false;}
return cookie_value;}
if(getCookieValue('noto-serif-loaded')){docElement.className+=" noto-serif-loaded";}
if(getCookieValue('nunito-loaded')){docElement.className+=" nunito-loaded";}})();
</script>





<script src="https://derekmorash.com/js/bundle.min.ef11d7f89f339226024806d26e72c7dc0f5527852fefe93e90cfd2086ee5394e.js"></script>
  

<link href="https://fonts.googleapis.com/css?family=Noto+Serif|Nunito:600" rel="stylesheet">


<style>
       

  .nunito,h1,h2,h3,h4,h5,h6{font-family:sans-serif;font-weight:400}html.nunito-loaded .nunito,html.nunito-loaded h1,html.nunito-loaded h2,html.nunito-loaded h3,html.nunito-loaded h4,html.nunito-loaded h5,html.nunito-loaded h6{font-family:nunito,sans-serif}/*!normalize.css v4.1.1 | MIT License | github.com/necolas/normalize.css*/html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}template,[hidden]{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}button,input,select,textarea{font:inherit;margin:0}button,select{text-transform:none}button,html [type=button],[type=reset],[type=submit]{-webkit-appearance:button}button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:0;margin:0;padding:0}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}html{box-sizing:border-box;font-size:16px;background:#fff}@media(min-width:900px){html{font-size:18px}}@media(min-width:1200px){html{font-size:20px}}*,*::before,*::after{box-sizing:border-box}body{font-size:1rem;font-family:serif;font-weight:400;font-style:normal;letter-spacing:.01em;line-height:1.5;background:#fff;color:#262626}html.noto-serif-loaded body{font-family:"noto serif",serif}p{margin:0 0 1.75rem}em{font-size:1rem;font-style:italic}strong{font-weight:400;font-style:normal;color:#000}a{color:#262626;text-decoration:underline;text-decoration-skip:objects;text-decoration-color:#0073e6;transition:color .2s}a:hover,a:hover:visited{color:#0073e6}h1,h2,h3,h4,h5,h6{margin:2.5em 0 .75rem;line-height:1.3;color:#000}h1{font-size:1.75rem}h2{font-size:1.5rem}h3{font-size:1.25rem}h4{font-size:1rem}h5{font-size:1rem}h6{font-size:1rem}h1+h2,h2+h3,h3+h4,h4+h5,h5+h6{margin-top:0}img{max-width:100%;height:auto}pre,code{font-family:courier new,Courier,monospace}pre{overflow:scroll}figure{margin:1rem 0}main{max-width:40rem;margin:0 auto;padding:1.5rem}
</style>

  
  <link rel="stylesheet" href="https://derekmorash.com/sass/main.min.e41efcb2cdeb4efc5c53f8046fcebdebb4ab905e79403cd3a0bfbbf300339bae.css" integrity=”sha256-5B78ss3rTvxcU/gEb86967SrkF55QDzToL&#43;78wAzm64&#61;”>
</head>

<body>
  <header role="banner" class="site-header">
    <div class="site-header__inner">

      
      <p class="logo"><a href="/">Derek Morash</a></p>
      

      <nav role="navigation" id="site-navigation" class="site-header__nav">
        <ul class="nav-list">
          
          
            <li class="nav-list__item">
              <a href="/blog/" class="nav-list__link">Blog</a>
            </li>
          
            <li class="nav-list__item">
              <a href="/about/" class="nav-list__link">About</a>
            </li>
          
        </ul>
      </nav>
    </div>
  </header>
 
<main class="site-main">
  <article role="main" class="blog-post">
    <header class="blog-post__header">

      
        <p class="blog-post__categories">
          
            Shopify
          
            Rails
          
        </p>
      

      <h1 class="blog-post__title">Handle Shopify Mandatory Webhooks in Ruby on Rails</h1>

      <aside class="blog-post__metadata">
        
        <p class="blog-post__date">Posted on <time datetime="2018-11-15">November 15, 2018</time></p>
      </aside>
    </header>

    <section class="blog-post__content rte">
      
      

<p>Since May 25th, 2018 GDPR has imposed obligations on any party that collects, stores, or processes personal data. App developers have the responsibility to comply with these regulations. Fortunately, Shopify has implemented endpoints to help app developers deal with data privacy to meet the requirements of GDPR.</p>

<p>Read about <a href="https://help.shopify.com/en/api/guides/gdpr-resources">Shopify API GDPR requirements</a>.</p>

<h2 id="mandatory-webhooks">Mandatory Webhooks</h2>

<p>Mandatory webhooks differ slightly from regular webhooks from Shopify. If you&rsquo;re using the <em>shopify_app</em> gem you can use the <a href="https://github.com/Shopify/shopify_app#webhooksmanager">webhooks manager</a> to configure your apps needed webhooks. Unfortunately this only works for the regular Shopify admin API events, the mandatory webhooks have to be set up manually. This doesn&rsquo;t mean the app gem can&rsquo;t help us out, we&rsquo;ll still use it for verifying webhooks, more on that later.</p>

<p>Read about <a href="https://help.shopify.com/en/api/getting-started/webhooks">getting started with Shopify webhooks</a>.</p>

<h2 id="mandatory-webhooks-controller">Mandatory Webhooks Controller</h2>

<p>Create a new controller called <code>MandatoryWebhooksController</code>. This controller will have three methods, an endpoint for each mandatory webhook.</p>

<p>Create (<code>app/controllers/mandatory_webhooks_controller.rb</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MandatoryWebhooksController</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ApplicationController</span>
  
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shop_redact</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">customer_redact</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">customer_data_request</span>
  <span style="color:#66d9ef">end</span>
  
<span style="color:#66d9ef">end</span></code></pre></div>
<p>Create a private method that only excepts only the params we want and returns them. The <code>except</code> method returns a hash with everything except for the given values.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">private</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">webhook_params</span>
    params<span style="color:#f92672">.</span>except(<span style="color:#e6db74">:controller</span>, <span style="color:#e6db74">:action</span>, <span style="color:#e6db74">:type</span>)
  <span style="color:#66d9ef">end</span></code></pre></div>
<p>Now we can use <code>webhook_params</code> in our controller methods to access the data sent by the webhook request.</p>

<h3 id="webhook-verification">Webhook Verification</h3>

<p>Webhooks need to be verified before being processed to be sure that the request came from shopify and not someone else.</p>

<p>In the header of the request, Shopify includes an HMAC. This is the SHA256 digest calculated from the body of the request and your apps shared secret. To verify the webhook you have to calculate this HMAC and compare it to the one in the request header, if they match then it is a valid webhook from Shopify.</p>

<p>Shopify&rsquo;s <a href="https://help.shopify.com/en/api/getting-started/webhooks#verify-webhook">getting started with webhooks guide</a> has a good section on how to manually verify webhooks.</p>

<p>Luckily the <a href="https://github.com/Shopify/shopify_app">shopify_app gem</a> can handle this for us, no need to worry about calculating and compare the HMAC. To do this include ShopifyApp::WebhookVerification at the start of the controller class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MandatoryWebhooksController</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ApplicationController</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">ShopifyApp</span><span style="color:#f92672">::</span><span style="color:#66d9ef">WebhookVerification</span>
  <span style="color:#f92672">...</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<h3 id="complete-the-endpoint-methods">Complete the endpoint methods</h3>

<p>Start by setting the params permitted attribute to true, then we can use <code>webhook_params</code> to do whatever we want with the webhook data.</p>

<p>Then we need to return a response to Shopify to say everything is okay. Mandatory webhooks need to respond with a 200 series status code. Calling <code>head :no_content</code> will respond with a <code>&quot;204 no content&quot;</code> status. We aren&rsquo;t sending any data back to Shopify with these webhooks so 204 just indicates that the webhook was received and there&rsquo;s nothing to send back.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shop_redact</span>
  params<span style="color:#f92672">.</span>permit!
  <span style="color:#75715e"># do something</span>
  head <span style="color:#e6db74">:no_content</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>Before <code>head</code> is called we can do whatever we want with the webhook data. We can log a ticket in your support system or send yourself an email with data.</p>

<h2 id="routes">Routes</h2>

<p>Now that the webhooks can be processed we need to set up routes that Shopify can post to when a webhook is fired. We can make the endpoint locations be whatever we want, then map them to the appropriate controller methods.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb">controller <span style="color:#e6db74">:mandatory_webhooks</span> <span style="color:#66d9ef">do</span>
  post <span style="color:#e6db74">&#39;/webhooks/shop_redact&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">:shop_redact</span>
  post <span style="color:#e6db74">&#39;/webhooks/customers_redact&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">:customers_redact</span>
  post <span style="color:#e6db74">&#39;/webhooks/customers_data_request&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">:customers_data_request</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>We then have to go into our apps set up in the partners dashboard and find the mandatory webhooks section. Here we specify the URLs for each webhook endpoint.</p>


<figure>
    
        <img src="/blog/handle-shopify-mandatory-webhooks/mandatory-webhooks.png" alt="Shopify app set up mandatory webhooks" />
    
    
    <figcaption>
        <p>
        
        
            Shopify app set up mandatory webhooks
        
        </p> 
    </figcaption>
    
</figure>


<p>Shopify can now send a mandatory webhook to our app and we will verify it and respond accordingly.</p>

<h2 id="jobs">Jobs</h2>

<p>One thing we might want to do is process the webhooks using ActiveJob instead of doing everything inline in the controller.</p>

<p>Create a job for each webhook like this (<code>app/jobs/shop_redact_job.rb</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ShopRedactJob</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveJob</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform</span>(<span style="color:#e6db74">shop_domain</span>:, <span style="color:#e6db74">webhook</span>:)
    shop <span style="color:#f92672">=</span> <span style="color:#66d9ef">Shop</span><span style="color:#f92672">.</span>find_by(<span style="color:#e6db74">shopify_domain</span>: shop_domain)

    shop<span style="color:#f92672">.</span>with_shopify_session <span style="color:#66d9ef">do</span>
      <span style="color:#75715e"># redact information related to this shop</span>
    <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>In this job, we can do all the processing we want like creating support tickets, deleting database information, sending emails, etc.</p>

<p>Lastly, we need to queue the job when the webhook is received. Modify the controller methods for each endpoint like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shop_redact</span>
  params<span style="color:#f92672">.</span>permit!
  <span style="color:#66d9ef">ShopRedactJob</span><span style="color:#f92672">.</span>perform_later(<span style="color:#e6db74">shop_domain</span>: shop_domain, <span style="color:#e6db74">webhook</span>: webhook_params<span style="color:#f92672">.</span>to_h)
  head <span style="color:#e6db74">:no_content</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>Now ActiveJob will handle the heavy lifting of the webhook and we don&rsquo;t have to worry about having the main app do extra processing.</p>

    </section>
  </article>
</main>
 
</body>
</html>