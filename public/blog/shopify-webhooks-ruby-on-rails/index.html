<html lang="en" class="no-js">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Handle Shopify Webhooks in Ruby on Rails</title>

  
<script>
  (function(){var docElement=document.documentElement;docElement.className=docElement.className.replace('no-js','js');function getCookieValue(cookie_name){cookie_name+="=";var cookie_value=false;var decoded_cookie=decodeURIComponent(document.cookie);var cookie_start=decoded_cookie.indexOf(cookie_name);var cookie_end=decoded_cookie.indexOf(";",cookie_start+1);cookie_end=cookie_end>1?cookie_end:decoded_cookie.length;if(cookie_start>=0&&cookie_end<=decoded_cookie.length){cookie_value=decoded_cookie.substring(cookie_start+cookie_name.length,cookie_end);}
if(cookie_value==="true"){cookie_value=true;}else if(cookie_value==="false"){cookie_value=false;}
return cookie_value;}
if(getCookieValue('inter-loaded')){docElement.className+=" inter-loaded";}})();
</script>





<script src="https://derekmorash.com/js/bundle.min.8a17fdd9466c77f7aa941806a4678d846c3a3c71c180eef34ebb4fed663a692f.js"></script>
  


<style>
       

  /*!normalize.css v4.1.1 | MIT License | github.com/necolas/normalize.css*/html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}progress{vertical-align:baseline}template,[hidden]{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}dfn{font-style:italic}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}button,input,select,textarea{font:inherit;margin:0}button,select{text-transform:none}button,html [type=button],[type=reset],[type=submit]{-webkit-appearance:button}button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}html{box-sizing:border-box;font-size:16px;background:#f6f6f6}@media(min-width:1280px){html{font-size:18px}}*,*::before,*::after{box-sizing:border-box}body{font-size:1rem;font-family:Helvetica,Arial,Verdana,sans-serif;font-family:inter,Helvetica,Arial,Verdana,sans-serif;font-weight:400;font-style:normal;letter-spacing:.002em;line-height:1.5;background:#f6f6f6;color:#262626}html.inter-loaded body{font-family:inter,Helvetica,Arial,Verdana,sans-serif}p{margin:.5rem 0}em{font-size:1rem;font-style:italic}strong{font-weight:600;font-style:normal;color:#000}a{color:#262626;text-decoration:underline;text-decoration-skip:objects;text-decoration-color:#009ec2;transition:color .05s}a:hover,a:hover:visited{color:#009ec2}h1,h2,h3,h4,h5,h6{margin:1.75em 0 .75rem;font-weight:600;font-style:normal;line-height:1.1;letter-spacing:-.03em;color:#000}h1{font-size:2.255rem}h2{font-size:2rem}h3{font-size:1.75rem}h4{font-size:1.5rem}h5{font-size:1.25rem}h6{font-size:1.25rem}h1+h2,h2+h3,h3+h4,h4+h5,h5+h6{margin-top:0}img{max-width:100%;height:auto}pre{overflow:scroll}figure{margin:1rem 0}
</style>

  
  <link rel="stylesheet" href="https://derekmorash.com/sass/main.min.70c065ee61e73218973f973e6404f6cb53da33de57439b84dc6124a17c78e1b7.css" integrity=”sha256-cMBl7mHnMhiXP5c&#43;ZAT2y1PaM95XQ5uE3GEkoXx44bc&#61;”>
</head>

<body>
  <header role="banner" class="site-header">
    <div class="site-header__inner">
      <h1 class="logo"><a href="/">Derek Morash</a></h1>

      <nav role="navigation" id="site-navigation" class="site-navigation">
        <ul>
          
          
            <li>
              <a href="/about/">About</a>
            </li>
          
            <li>
              <a href="/blog/">Blog</a>
            </li>
          
        </ul>
      </nav>
    </div>
  </header>
 
<main class="site-main">
  <article role="main" class="blog-post">
    <header class="blog-post__header">
      <div class="blog-post__header--inner">
        <h1>Handle Shopify Webhooks in Ruby on Rails</h1>
  
        
        <aside class="postmetadata">Posted on <time datetime="2018-11-27 00:00:00 &#43;0000 UTC">2018-11-27 00:00:00 &#43;0000 UTC</time></aside>
      </div>
    </header>

    <section class="blog-post__content rte">
      

<p>Webhooks are a way for Shopify to send data to your app when events in a merchants store happen, such as order or product updates. The ShopifyApp gem makes it easy to subscribe to and manage the webhooks that are required for your app. We&rsquo;ll look at two ways of handling webhooks using the ShopifyApp gem in Ruby on Rails.</p>

<p><strong>Note about Mandatory Webhooks:</strong></p>

<p>If you&rsquo;re using the <em>shopify_app</em> gem you can use the <a href="https://github.com/Shopify/shopify_app#webhooksmanager">webhooks manager</a> to configure the webhooks our app needs. However, Mandatory webhooks differ slightly in the way they&rsquo;re configured. I have another article about how to set these up [Mandatory-Webhooks.md]().</p>

<h2 id="configure-webhook">Configure Webhook</h2>

<p>Start by subscribing to the webhooks we want our app to listen for.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">ShopifyApp</span><span style="color:#f92672">.</span>configure <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>config<span style="color:#f92672">|</span>
  config<span style="color:#f92672">.</span>webhooks <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
    {<span style="color:#e6db74">topic</span>: <span style="color:#e6db74">&#39;orders/create&#39;</span>, <span style="color:#e6db74">address</span>: <span style="color:#e6db74">&#39;https://my-app.com/webhooks/orders_create&#39;</span>}
    {<span style="color:#e6db74">topic</span>: <span style="color:#e6db74">&#39;orders/update&#39;</span>, <span style="color:#e6db74">address</span>: <span style="color:#e6db74">&#39;https://my-app.com/webhooks/orders_update&#39;</span>}
    {<span style="color:#e6db74">topic</span>: <span style="color:#e6db74">&#39;orders/paid&#39;</span>, <span style="color:#e6db74">address</span>: <span style="color:#e6db74">&#39;https://my-app.com/webhooks/orders_paid&#39;</span>}
  <span style="color:#f92672">]</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>This will subscribe your app to a shops webhooks when the app is installed by a merchant. The topic tells Shopify which webhook to subscribe to and the address is the URL for your app that you want the webhook to be sent to.</p>

<h2 id="jobs">Jobs</h2>

<p>Create a job for each webhook like this (<code>app/jobs/orders_create_job.rb</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrdersCreateJob</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveJob</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform</span>(<span style="color:#e6db74">shop_domain</span>:, <span style="color:#e6db74">webhook</span>:)
    shop <span style="color:#f92672">=</span> <span style="color:#66d9ef">Shop</span><span style="color:#f92672">.</span>find_by(<span style="color:#e6db74">shopify_domain</span>: shop_domain)

    shop<span style="color:#f92672">.</span>with_shopify_session <span style="color:#66d9ef">do</span>
      <span style="color:#75715e"># redact information related to this shop</span>
    <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>In this job, we can do all the processing we want like updating a database, sending emails with the webhook data, or creating support tickets.</p>

<p>If our app is using a job queuing service like Sidekiq then these jobs will be processed in the background, if not the job will just be run inline.</p>

<p>That&rsquo;s it, as long as you create a job that matches its webhook topic then the ShopifyApp gem will handle it.</p>

<h2 id="custom-webhooks-controller">Custom webhooks controller</h2>

<p>The ShopifyApp gem is now receiving the webhook and sending it to ActiveJob to be processed. That&rsquo;s it, we&rsquo;re done! You may however want to have your own controller to handle webhooks. If your app needs to do something different than just queuing a job then the default webhook manager may be limiting for you. The ShopifyApp gem can still help us with this.</p>

<h2 id="routes">Routes</h2>

<p>Now that the webhooks are configured we need to set up routes that Shopify can post to when a webhook is fired. We can make the endpoint locations be whatever we want, then map them to the appropriate controller methods (we will make this controller after).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb">post <span style="color:#e6db74">&#39;/webhooks/orders_create&#39;</span>, <span style="color:#e6db74">:to</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;custom_webhooks#orders_create&#39;</span>
post <span style="color:#e6db74">&#39;/webhooks/orders_update&#39;</span>, <span style="color:#e6db74">:to</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;custom_webhooks#orders_update&#39;</span>
post <span style="color:#e6db74">&#39;/webhooks/orders_paid&#39;</span>, <span style="color:#e6db74">:to</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;custom_webhooks#orders_paid&#39;</span></code></pre></div>
<h2 id="custom-webhooks-controller-set-up">Custom webhooks controller set up</h2>

<p>Create a new controller called <code>CustomWebhooksController</code>. Add methods for each webhook we want to use to the controller.</p>

<pre><code>rails generate controller CustomWebhooks
</code></pre>

<p>Or manually create <code>app/controllers/custom_webhooks_controller.rb</code>.</p>

<p>Add stub endpoint methods:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomWebhooksController</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ApplicationController</span>
  
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">orders_create</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">orders_update</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">orders_paid</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#f92672">...</span>

<span style="color:#66d9ef">end</span></code></pre></div>
<p>Create a private method that only excepts only the params we want and returns them. The <code>except</code> method returns a hash with everything except for the given values.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">private</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">webhook_params</span>
  params<span style="color:#f92672">.</span>except(<span style="color:#e6db74">:controller</span>, <span style="color:#e6db74">:action</span>, <span style="color:#e6db74">:type</span>)
<span style="color:#66d9ef">end</span></code></pre></div>
<p>Now we can use <code>webhook_params</code> in our controller methods to access the data sent by the webhook request.</p>

<h3 id="webhook-verification">Webhook verification</h3>

<p>Webhooks need to be verified before being processed to be sure that the request came from shopify and not someone else.</p>

<p>In the header of the request, Shopify includes an HMAC. This is the SHA256 digest calculated from the body of the request and your apps shared secret. To verify the webhook you have to calculate this HMAC and compare it to the one in the request header, if they match then it is a valid webhook from Shopify.</p>

<p>Shopify&rsquo;s <a href="https://help.shopify.com/en/api/getting-started/webhooks#verify-webhook">getting started with webhooks guide</a> has a good section on how to manually verify webhooks.</p>

<p>Luckily the <a href="https://github.com/Shopify/shopify_app">shopify_app gem</a> can handle this for us, no need to worry about calculating and compare the HMAC. To do this include ShopifyApp::WebhookVerification at the start of the controller class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomWebhooksController</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ApplicationController</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">ShopifyApp</span><span style="color:#f92672">::</span><span style="color:#66d9ef">WebhookVerification</span>
  <span style="color:#f92672">...</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<h3 id="complete-the-endpoint-methods">Complete the endpoint methods</h3>

<p>Start by setting the params permitted attribute to true, then we can use <code>webhook_params</code> to do whatever we want with the webhook data.</p>

<p>Then we need to return a response to Shopify to say everything is okay. Webhooks need to respond with a 200 series status code. Calling <code>head :no_content</code> will respond with a <code>&quot;204 no content&quot;</code> status. We aren&rsquo;t sending any data back to Shopify with these webhooks so 204 just indicates that the webhook was received and there&rsquo;s nothing to send back.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">orders_create</span>
  params<span style="color:#f92672">.</span>permit!
  <span style="color:#66d9ef">OrdersCreateJob</span><span style="color:#f92672">.</span>perform_later(<span style="color:#e6db74">shop_domain</span>: shop_domain, <span style="color:#e6db74">webhook</span>: webhook_params<span style="color:#f92672">.</span>to_h)
  head <span style="color:#e6db74">:no_content</span>
<span style="color:#66d9ef">end</span></code></pre></div>
<p>Before <code>head</code> is called we can do whatever we want with the webhook data. Here we are queuing the job we created earlier.</p>

<p>Now ActiveJob will handle the heavy lifting of the webhook in the background and we don&rsquo;t have to worry about having the main app do extra processing.</p>

    </section>
  </article>
</main>
 
</body>
</html>